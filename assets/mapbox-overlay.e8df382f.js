import{f as k,_ as c,D as b,a as f}from"./layer.6384b77b.js";import{M as E,g,b as m,c as I}from"./mapbox-layer.23573ae4.js";const v="__UNDEFINED__";function h(d,e,n,l){if(!d||!e||!d.style||!d.style._loaded)return;const o=k(l,Boolean);if(n!==l){const s=k(n,Boolean),i=new Set(s.map(a=>a.id));for(const a of o)i.delete(a.id);for(const a of i)d.getLayer(a)&&d.removeLayer(a)}for(const s of o){const i=d.getLayer(s.id);i?i.implementation.setProps(s.props):d.addLayer(new E({id:s.id,deck:e}),s.props.beforeId)}const r=d.style._order,t={};for(const s of o){let{beforeId:i}=s.props;(!i||!r.includes(i))&&(i=v),t[i]=t[i]||[],t[i].push(s.id)}for(const s in t){const i=t[s];let a=s===v?r.length:r.indexOf(s),u=s===v?void 0:s;for(let _=i.length-1;_>=0;_--){const p=i[_],y=r.indexOf(p);y!==a-1&&(d.moveLayer(p,u),y>a&&a++),a--,u=p}}}class S{constructor(e){c(this,"_props",void 0),c(this,"_deck",void 0),c(this,"_map",void 0),c(this,"_container",void 0),c(this,"_interleaved",void 0),c(this,"_handleStyleChange",()=>{h(this._map,this._deck,this._props.layers,this._props.layers)}),c(this,"_updateContainerSize",()=>{if(this._map&&this._container){const{clientWidth:o,clientHeight:r}=this._map.getContainer();Object.assign(this._container.style,{width:"".concat(o,"px"),height:"".concat(r,"px")})}}),c(this,"_updateViewState",()=>{const o=this._deck;o&&(o.setProps({viewState:g(this._map)}),o.redraw())}),c(this,"_handleMouseEvent",o=>{const r=this._deck;if(!r)return;const t={type:o.type,offsetCenter:o.point,srcEvent:o};switch(o.type){case"click":t.tapCount=1,r._onPointerDown(t),r._onEvent(t);break;case"dblclick":t.type="click",t.tapCount=2,r._onEvent(t);break;case"mousemove":t.type="pointermove",r._onPointerMove(t);break;case"mouseout":t.type="pointerleave",r._onPointerMove(t);break;default:return}});const{interleaved:n=!1,...l}=e;this._interleaved=n,this._props=l}setProps(e){this._interleaved&&e.layers&&h(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._deck.setProps(this._interleaved?m(this._props):this._props)}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const n=document.createElement("div");return Object.assign(n.style,{position:"absolute",left:0,top:0,pointerEvents:"none"}),this._container=n,this._deck=new b({...this._props,parent:n,viewState:g(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),n}_onAddInterleaved(e){return this._deck=I({map:e,gl:e.painter.context.gl,deck:new b({...this._props,gl:e.painter.context.gl})}),e.on("styledata",this._handleStyleChange),h(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){var e;const n=this._map;n&&(this._interleaved?this._onRemoveInterleaved(n):this._onRemoveOverlaid(n)),(e=this._deck)===null||e===void 0||e.finalize(),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent)}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),h(e,this._deck,this._props.layers,[])}getDefaultPosition(){return"top-left"}pickObject(e){return f(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return f(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return f(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}}export{S as M};
